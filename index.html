<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Document</title>
  <link rel="stylesheet" href="./lib/index.css" />
</head>

<body>
  <h1>IndexedDB Demo</h1>
  <div class="ctrlbar">
    <div class="ctrl-add active" data-add>添加 add</div>
    <div class="ctrl-put" data-put>修改 put</div>
    <div class="ctrl-delete" data-delete>删除 delete</div>
    <div class="ctrl-query" data-query>查找 query</div>
  </div>
  <div class="test">
    <div class="ctrl add show">
      <ul>
        <li class="use-id">
          <label for="">ID</label>
          <input type="text" class="id" placeholder="请输入id" />
        </li>
        <li class="use-name">
          <label for="">姓名</label>
          <input type="text" class="name" placeholder="请输入姓名" />
        </li>
        <li class="use-school">
          <label for="">学校</label>
          <input type="text" class="school" placeholder="请输入学校" />
        </li>
        <li>
          <button id="addData">添加</button>
        </li>
      </ul>
    </div>
    <div class="ctrl put hide">
      <ul>
        <li class="use-id">
          <label for="">ID</label>
          <input type="text" class="id" placeholder="请输入id" />
        </li>
        <li class="use-name">
          <label for="">姓名</label>
          <input type="text" class="name" placeholder="请输入姓名" />
        </li>
        <li class="use-school">
          <label for="">学校</label>
          <input type="text" class="school" placeholder="请输入学校" />
        </li>
        <li>
          <button id="putData">修改</button>
        </li>
      </ul>
    </div>
    <div class="ctrl delete hide">
      <ul>
        <li class="use-id">
          <label for="">ID</label>
          <input type="text" class="id" placeholder="请输入id" />
        </li>
        <li class="use-name">
          <label for="">姓名</label>
          <input type="text" class="name" placeholder="请输入姓名" />
        </li>
        <li class="use-school">
          <label for="">学校</label>
          <input type="text" class="school" placeholder="请输入学校" />
        </li>
        <li>
          <button id="deleteData">删除</button>
        </li>
      </ul>
    </div>
    <div class="ctrl query hide">
      <ul>
        <li class="use-id">
          <label for="">ID</label>
          <input type="text" class="id" placeholder="请输入id" />
        </li>
        <li class="use-name">
          <label for="">姓名</label>
          <input type="text" class="name" placeholder="请输入姓名" />
        </li>
        <li class="use-school">
          <label for="">学校</label>
          <input type="text" class="school" placeholder="请输入学校" />
        </li>
        <li>
          <button id="queryData">查找</button>
        </li>
      </ul>
    </div>
  </div>
  <h2>预览 previews</h2>
  <div class="show-data">
    <div class="show-head">
      <ul>
        <li>id</li>
        <li>姓名</li>
        <li>学校</li>
      </ul>
    </div>
    <div id="showData"></div>
  </div>
</body>
<script src="./lib/bundle.js"></script>

<script>

  const ctrlbar = document.querySelector('.ctrlbar');
  const testNode = document.querySelector('.test');
  const cache = {
    ctrlbar:[ctrlbar.children[0]],
    test: [testNode.children[0]]
  }
  ctrlbar.addEventListener('click', function (e) {
    if(Reflect.ownKeys(e.target.dataset).length === 0) {
      return false
    }
    if(cache.ctrlbar.length > 0) {
      cache.ctrlbar[0].classList.remove('active')
      cache.ctrlbar.length = 0
    }
    if(cache.test.length > 0) {
      cache.test[0].classList.remove('show')
      cache.test.length = 0
    }
    cache.ctrlbar.push(e.target)
    for(const key in e.target.dataset) {
      const showNode = testNode.querySelector(`.${key}`)
      showNode.classList.add('show')
      cache.test.push(showNode)
    }
    console.dir(e.target)
    e.target.classList.add('active')
  })
  const options = {
    databaseName: "test",
    tables: [{
      name: "table_student",
      keyPath: "id",
      autoIncrement: true,
      indexs: [{
          index: "id",
          relativeIndex: "id",
          unique: true
        },
        {
          index: "name",
          relativeIndex: "name",
          unique: false
        },
        {
          index: "school",
          relativeIndex: "school",
          unique: false
        }
      ]
    }]
  };
  const test = new TinyDB(options);

  // test.insert('table_student', {name: '李1', school : '北京大学1'})
  // test.insert('table_student', {name: '李2', school : '北京大学2'})
  // test.insert('table_student', {name: '李2', school : '北京大学2'})
  // test.insert('table_student', {name: '李3', school : '北京大学3'})
  // test.insert('table_student', {name: '李4', school : '北京大学4'})
  // test.insert('table_student', {name: '李5', school : '北京大学5'})
  // test.some('table_student', 'name', '李1', '李4')
  // test.clearTable('table_student').then( res=> {
  //   console.log(res)
  // }).catch(err=>{
  //   console.log(err)
  // })
  const add = document.querySelector("#addData");
  const put = document.querySelector("#putData");
  const _delete = document.querySelector("#deleteData");
  const query = document.querySelector("#queryData");
  let wrap = document.querySelector("#showData");
  let frame = document.createDocumentFragment();

  showData();
  add.onclick = () => {
    let inputs = document.querySelectorAll(".add input");
    let data = {
      name: inputs[1].value,
      school: inputs[2].value
    };
    if (inputs[0].value !== "") data.id = inputs[0].value;
    test.insert("table_student", data);
    showData();
  };
  put.onclick = () => {
    let inputs = document.querySelectorAll(".put input");
    let data = {
      name: inputs[1].value,
      school: inputs[2].value
    };
    if (inputs[0].value !== "") data.id = +inputs[0].value;
    test.update("table_student", data);
    showData();
  };

  _delete.onclick = () => {
    let inputs = document.querySelectorAll(".delete input");
    let data = {};
    inputs.forEach(item => {
      if (item.value !== "") {
        data[`${item.className}`] = item.value;
        test.delete("table_student", data).then(res => {
          showData();
        });
      }
    });
  };
  query.onclick = () => {
    let inputs = document.querySelectorAll(".query input");
    let data = {};
    inputs.forEach(item => {
      if (item.value !== "") {
        if (item.className === "id") {
          data[`${item.className}`] = parseInt(item.value);
          test.selectId("table_student", parseInt(item.value)).then(res => {
            console.log(res)
            const ul = new Element("ul", {
              id: "db-data"
            }, [
              new Element("li", {
                class: "id"
              }, [`${res.id}`]),
              new Element("li", {
                class: "name"
              }, [`${res.name}`]),
              new Element("li", {
                class: "school"
              }, [`${res.school}`])
            ]);
            frame.append(ul.render());

            wrap.innerHTML = ``;
            wrap.append(frame);
          });
        } else {
          data[`${item.className}`] = item.value;
          test.select("table_student", data).then(res => {
            res.forEach(item => {
              const ul = new Element("ul", {
                id: "db-data"
              }, [
                new Element("li", {
                  class: "id"
                }, [`${item.id}`]),
                new Element("li", {
                  class: "name"
                }, [`${item.name}`]),
                new Element("li", {
                  class: "school"
                }, [`${item.school}`])
              ]);
              // console.log(ul)
              frame.append(ul.render());
            });
            wrap.innerHTML = ``;
            wrap.append(frame);
          });
        }
      }
    });
  };

  const Element = function (tagName, props, children) {
    this.tagName = tagName;
    this.props = props;
    this.children = children;
  };

  Element.prototype.render = function () {
    const ele = document.createElement(this.tagName);
    const props = this.props;

    for (var propsName in props) {
      var propsValue = props[propsName];
      ele.setAttribute(propsName, propsValue);
    }
    const children = this.children || [];
    children.forEach(child => {
      const childEl =
        child instanceof Element ?
        child.render() :
        document.createTextNode(child);
      ele.appendChild(childEl);
    });
    return ele;
  };
  const createElement = function (tagName, props, children) {
    return new Element(tagName, props, children);
  };

  function showData() {
    test.selectAll("table_student").then(res => {
      res.forEach(item => {
        const ul = new Element("ul", {
          id: "db-data"
        }, [
          new Element("li", {
            class: "id"
          }, [`${item.id}`]),
          new Element("li", {
            class: "name"
          }, [`${item.name}`]),
          new Element("li", {
            class: "school"
          }, [`${item.school}`])
        ]);
        frame.append(ul.render());
      });
      wrap.innerHTML = ``;
      requestAnimationFrame(() => {
        wrap.append(frame);
      })
    });
  }

</script>

</html>
